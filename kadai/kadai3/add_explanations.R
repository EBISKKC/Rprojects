# 課題3の結果に解説を追加するスクリプト

if (!require(openxlsx)) install.packages("openxlsx")
library(openxlsx)

# 既存のワークブックを読み込み
wb <- loadWorkbook("kadai3_results.xlsx")

# =======================================================
# 課題①の解説
# =======================================================
explanation1 <- data.frame(
  セクション = c(
    "分析目的",
    "分析方法",
    "結果概要",
    "有意差のあった変数1",
    "有意差のあった変数2",
    "有意差のあった変数3",
    "有意差のあった変数4",
    "考察1",
    "考察2",
    "考察3",
    "統計的有意性"
  ),
  内容 = c(
    "東日本と西日本の都道府県データにおいて、各連続変数の平均値に統計的に有意な差があるかを検証する。ウェルチのt検定を使用し、等分散性を仮定しない頑健な検定を実施した。有意水準は5%(p<0.05)を基準とし、1%水準(p<0.01)でも評価した。",

    "ウェルチのt検定(Welch's t-test)を使用。この検定は2群間の平均値の差を検定する方法で、等分散性を仮定しないため、より頑健な結果が得られる。各変数について東日本と西日本のデータを抽出し、t.test()関数でvar.equal=FALSEを指定して実行した。",

    "11個の連続変数のうち、4個の変数で東日本と西日本の間に有意な差が認められた。具体的には、nm_m_30(30-34歳男性未婚率)、w_pop(生産年齢人口割合)、conv(コンビニ数)、sm(専門スーパー数)である。いずれも東日本の値が西日本より高い。",

    "nm_m_30(30-34歳男性未婚率): p=0.0026** | 東日本41.69% > 西日本38.96% | 差は約2.7ポイント。東日本には大都市圏が多く、晩婚化・未婚化の傾向が顕著。都市部での生活様式、キャリア志向、価値観の多様化などが影響していると考えられる。",

    "w_pop(生産年齢人口割合): p=0.0420* | 東日本64.77% > 西日本63.26% | 差は約1.5ポイント。東日本の生産年齢人口割合が高いことは、若年層の流入や経済活動の活発さを反映している。雇用機会の多さや地域経済の活性度と関連していると推測される。",

    "conv(コンビニエンスストア数): p=0.0265* | 東日本1243.91件 > 西日本588.67件 | 東日本は西日本の約2.1倍。人口密度の高さ、都市化の程度、24時間営業需要の高さを反映。東京圏を中心とした都市部では小売インフラが高度に発達している。",

    "sm(専門スーパーマーケット数): p=0.0082** | 東日本973.26件 > 西日本576.46件 | 東日本は西日本の約1.7倍。人口規模が大きく、商圏も広いため、専門スーパーの出店数が多い。消費者の購買力や多様なニーズに対応した店舗展開が進んでいる。",

    "【地域特性の違い】東日本と西日本では、人口構成、生活様式、小売インフラに明確な違いがある。東日本は大都市圏を中心に人口が集中し、都市化が進んでいる。これが未婚率の高さや小売店舗数の多さにつながっている。一方、西日本は比較的地方都市が分散しており、都市集中度が低い。",

    "【経済活動と人口構成】生産年齢人口割合が高い東日本は、経済活動が活発で、若年層を引き付ける魅力がある。これは雇用機会の多さ、高い賃金水準、教育機関の充実などによるもの。逆に西日本では高齢化がやや進んでいる可能性がある。",

    "【小売戦略への示唆】コンビニや専門スーパーの出店数の違いは、小売業の地域戦略を考える上で重要。東日本では高密度な店舗展開が可能で、西日本ではより広範囲をカバーする戦略が必要。地域特性に応じた出店計画が求められる。",

    "**記号の意味: **(p<0.01)=1%水準で有意、99%以上の確率で差がある。*(p<0.05)=5%水準で有意、95%以上の確率で差がある。有意差なし(p>=0.05)=統計的に明確な差があるとは言えない。p値が小さいほど、その差が偶然である可能性は低い。"
  ),
  stringsAsFactors = FALSE
)

addWorksheet(wb, "課題1_解説", gridLines = FALSE)
writeData(wb, "課題1_解説", explanation1, startRow = 1, startCol = 1)
setColWidths(wb, "課題1_解説", cols = 1, widths = 20)
setColWidths(wb, "課題1_解説", cols = 2, widths = 100)

# =======================================================
# 課題②の解説
# =======================================================
explanation2 <- data.frame(
  セクション = c(
    "分析目的",
    "分析方法",
    "結果概要",
    "結果1_pop",
    "結果2_nm_m_30",
    "結果3_w_pop",
    "結果4_conv",
    "結果5_sm",
    "多重比較の重要性",
    "考察1",
    "考察2",
    "考察3"
  ),
  内容 = c(
    "東日本、中日本、西日本の3つの地域間で、各連続変数の平均値に統計的に有意な差があるかを検証する。課題①では2地域の比較だったが、ここでは3地域を同時に比較することで、より詳細な地域差を明らかにする。",

    "1要因分散分析(One-way ANOVA)を使用。この分析は3群以上の平均値の差を同時に検定する方法。aov()関数を使用し、F検定により群間の差を評価した。有意差が認められた変数については、多重比較(Tukey HSD検定)を実施し、どの地域間に差があるのかを特定した。",

    "11個の連続変数のうち、5個の変数で3地域間に有意な差が認められた。pop(人口総数)、nm_m_30(男性未婚率)、w_pop(生産年齢人口割合)、conv(コンビニ数)、sm(専門スーパー数)。多くの変数で東日本の値が最も高く、西日本が最も低い傾向が見られた。",

    "pop(人口総数): F=4.03, p=0.0248* | 平均: 東日本4054千人、中日本2783千人、西日本1557千人。多重比較の結果、東日本と西日本の間に有意差あり(p=0.0186)。東日本には東京、神奈川、埼玉など人口の多い都道府県が集中している。",

    "nm_m_30(30-34歳男性未婚率): F=8.20, p=0.0009** | 平均: 東日本42.74%、中日本39.56%、西日本38.97%。多重比較で東日本vs中日本(p=0.0073**)、東日本vs西日本(p=0.0012**)に有意差。中日本と西日本の差は有意ではない。東日本の未婚率が突出して高い。",

    "w_pop(生産年齢人口割合): F=7.12, p=0.0021** | 平均: 東日本65.31%、中日本64.56%、西日本62.40%。多重比較で東日本vs西日本(p=0.0025**)、中日本vs西日本(p=0.0233*)に有意差。西日本の生産年齢人口割合が他の地域より低く、高齢化が進んでいる可能性。",

    "conv(コンビニエンスストア数): F=5.30, p=0.0086** | 平均: 東日本1533件、中日本832件、西日本468件。多重比較で東日本と西日本の間に有意差(p=0.0065**)。東日本は西日本の約3.3倍。人口規模の差以上に店舗密度が高い。",

    "sm(専門スーパーマーケット数): F=5.70, p=0.0063** | 平均: 東日本1082件、中日本778件、西日本507件。多重比較で東日本と西日本の間に有意差(p=0.0043**)。小売インフラの地域格差が顕著。",

    "ANOVAで有意差が出ても、どの群とどの群の間に差があるのかは分からない。そのため多重比較(Tukey HSD)を実施する必要がある。本分析では、多くの変数で東日本と西日本の間に有意差があり、中日本は中間的な位置づけであることが明らかになった。",

    "【3地域の特徴】東日本: 人口が多く、都市化が進み、小売インフラが充実。未婚率も高い。中日本: 多くの指標で中間的な値。東西の橋渡し的な地域特性。西日本: 人口が少なく、生産年齢人口割合が低い。小売店舗数も少ない。地理的・経済的な地域差が数値に表れている。",

    "【段階的な地域差】東→中→西と段階的に値が変化する変数が多い。これは日本列島の東西で、歴史的・地理的・経済的な勾配が存在することを示唆。特に東京を中心とした首都圏の影響力が、東日本全体の数値を押し上げている。",

    "【政策的示唆】地域間格差の存在は、地方創生や国土の均衡ある発展を考える上で重要な知見。西日本では人口減少・高齢化への対策が急務。東日本では都市問題(混雑、未婚化など)への対応が必要。中日本は両方の特性を持つため、柔軟な地域政策が求められる。"
  ),
  stringsAsFactors = FALSE
)

addWorksheet(wb, "課題2_解説", gridLines = FALSE)
writeData(wb, "課題2_解説", explanation2, startRow = 1, startCol = 1)
setColWidths(wb, "課題2_解説", cols = 1, widths = 20)
setColWidths(wb, "課題2_解説", cols = 2, widths = 100)

# =======================================================
# 課題③の解説
# =======================================================
explanation3 <- data.frame(
  セクション = c(
    "分析目的",
    "分析方法",
    "要因の定義",
    "結果概要",
    "地域要因の結果",
    "人口要因の結果",
    "交互作用の結果",
    "交互作用の意味",
    "考察1_複合的影響",
    "考察2_女性未婚率",
    "考察3_経済指標",
    "実践的示唆"
  ),
  内容 = c(
    "2つの要因(地域と人口規模)が各連続変数に与える影響を同時に検証する。また、2つの要因の交互作用(組み合わせ効果)の有無も検証する。これにより、単一要因では見えなかった複雑な関係性を明らかにする。",

    "2要因分散分析(Two-way ANOVA)を使用。要因1: 地域(東日本、中日本、西日本)、要因2: 人口規模(170万人以上、170万人未満)。aov()関数でvalue ~ area * pop_catとして交互作用項を含めて分析。pop(人口総数)は要因として使用しているため分析対象から除外し、10変数について分析した。",

    "【要因1:地域】東日本14都道府県、中日本16県、西日本17府県。【要因2:人口規模】170万人(1700千人)を境界値として設定。170万人以上24都道府県、170万人未満23道県。人口規模の分布: 東日本(以上10、未満4)、中日本(以上9、未満7)、西日本(以上5、未満12)。東日本に大都市が集中している。",

    "10個の変数について分析した結果: 地域のみに有意差=1変数(divorce)、人口規模のみに有意差=1変数(nm_f_30、gpp)、両方に有意差=5変数(nm_m_30は地域のみ、w_pop/conv/gsm/smは両方)、交互作用あり=1変数(w_pop)。多くの変数で地域と人口規模の両方が影響している。",

    "地域に有意差がある変数(6個): nm_m_30(F=8.88,p=0.0006**)、w_pop(F=10.86,p=0.0002**)、divorce(F=3.25,p=0.0488*)、conv(F=6.95,p=0.0025**)、gsm(F=3.42,p=0.0423*)、sm(F=10.56,p=0.0002**)。人口規模とは独立して、地域固有の特性が影響を与えている。",

    "人口規模に有意差がある変数(6個): nm_f_30(F=5.04,p=0.0303*)、w_pop(F=15.01,p=0.0004**)、conv(F=14.46,p=0.0005**)、gsm(F=16.55,p=0.0002**)、sm(F=38.46,p<0.0001**)、gpp(F=8.51,p=0.0057**)。特に小売店舗数(sm)は人口規模の影響が極めて大きい(F=38.46)。",

    "交互作用がある変数: w_pop(生産年齢人口割合)のみ(F=5.58,p=0.0072**)。交互作用プロットから読み取れること: 170万人以上の都道府県では地域による差が小さい(東中西で横並び)。170万人未満の都道府県では東日本が他地域より高い(東が突出)。人口規模による影響が地域によって異なる。",

    "交互作用とは「要因の組み合わせによる効果」を意味する。w_popの場合、人口規模が大きい都道府県では地域差が平準化されるが、人口規模が小さい都道府県では地域特性がより強く表れる。これは「大都市では全国的に似た傾向だが、地方都市では地域色が強い」ことを示唆している。",

    "【複合的な影響の理解】1要因分析では「地域差がある」「人口規模差がある」という単純な結論しか得られない。しかし2要因分析により「地域と人口規模が独立に影響している」「両者の組み合わせ効果も存在する」という複雑な関係性が明らかになった。現実社会の現象は複数の要因が絡み合っているため、多要因分析が重要。",

    "【女性未婚率の特徴】nm_f_30(30-34歳女性未婚率)は人口規模のみに有意差があり、地域差は認められなかった。男性(nm_m_30)は地域差が顕著だったのと対照的。これは女性の未婚率が全国的な傾向として人口規模(都市化の程度)に影響されることを示す。地域による文化的差異よりも、都市化という共通要因の影響が大きい。",

    "【経済指標と人口規模】gpp(県内総生産額)は人口規模のみに有意差があり、地域差は有意でない。これは経済規模が人口に強く依存することを示す。小売店舗数(conv/gsm/sm)は地域と人口規模の両方に有意差があるが、特に人口規模の影響が大きい。小売業の出店戦略では人口規模が最重要要因となる。",

    "【政策立案への示唆】人口規模が小さい地域では地域固有の特性を活かした政策が重要。人口規模が大きい地域では全国共通の施策が有効。【市場戦略への示唆】小売業では人口規模が最重要だが地域特性も考慮すべき。特に地方都市では地域ごとのカスタマイズが必要。【研究手法の重要性】交互作用の検出により、単純な主効果だけでは見えない複雑な関係性を理解できた。"
  ),
  stringsAsFactors = FALSE
)

addWorksheet(wb, "課題3_解説", gridLines = FALSE)
writeData(wb, "課題3_解説", explanation3, startRow = 1, startCol = 1)
setColWidths(wb, "課題3_解説", cols = 1, widths = 20)
setColWidths(wb, "課題3_解説", cols = 2, widths = 100)

# =======================================================
# 総合まとめ
# =======================================================
summary <- data.frame(
  項目 = c(
    "3つの課題の関係性",
    "段階的分析の意義",
    "主要な発見1",
    "主要な発見2",
    "主要な発見3",
    "統計的検定の重要性",
    "データから見る社会像",
    "分析の限界",
    "今後の課題",
    "結論"
  ),
  内容 = c(
    "本分析では段階的に分析の複雑さを増していった。【課題①】2群の比較(東日本vs西日本)→最もシンプルな比較。基本的な地域差を把握。【課題②】3群の比較(東日本vs中日本vs西日本)→より詳細な地域区分でどの地域間に差があるのかを特定。【課題③】2要因の同時分析(地域×人口規模)→複数の要因の影響とそれらの相互作用を検証。",

    "単純な分析から複雑な分析へと段階を踏むことで、データの背後にある構造を多角的に理解できた。課題①で「東西差がある」と分かり、課題②で「実は東日本が突出している」と判明し、課題③で「人口規模の影響も大きく、両者の組み合わせ効果もある」ことが明らかになった。このように段階的に深掘りすることで、より正確で詳細な知見が得られる。",

    "【東日本の特徴】人口が多い(平均4054千人)、30-34歳男性の未婚率が高い(約42%)、生産年齢人口割合が高い(約65%)、小売店舗数が多い(コンビニ約1533件、専門スーパー約1082件)。大都市圏の集中により、都市型の社会構造を持つ。経済活動が活発で若年層を引き付ける一方、未婚化・晩婚化も進行。",

    "【人口規模の影響】170万人以上の都道府県では、小売店舗数や経済規模が大きく、地域差が相対的に小さくなる傾向。170万人未満の都道府県では、地域特性がより強く表れる。人口規模は特に小売業や経済指標に強く影響し、小売店舗数は人口規模との相関が極めて高い(2要因分散分析でsmのF値=38.46)。",

    "【交互作用の発見】w_pop(生産年齢人口割合)で交互作用が検出された。大都市では地域による差が小さいが、地方都市では地域色が強い。これは「都市化による平準化」と「地域固有性の保持」のバランスを示す重要な知見。交互作用を考慮しない単純な分析では、この複雑な関係性を見落としていた可能性がある。",

    "単に「平均値に差がある」と観察するだけでなく、統計的検定により「その差が偶然ではなく真の差である可能性が高い」ことを確認できた。p値が小さいほど、その差が偶然である可能性は低く、より確信を持って「差がある」と結論できる。本分析では有意水準5%(p<0.05)と1%(p<0.01)を使い分け、証拠の強さを評価した。",

    "【都市化と社会変化】都市部に人口が集中する東日本では未婚率が高い。これはキャリア志向の高まり、晩婚化、価値観の多様化、経済的自立などを反映。【経済格差】人口規模と経済活動(県内総生産額)には強い相関。大都市圏を抱える地域ほど経済規模が大きい。【小売業の立地戦略】コンビニや専門スーパーの出店は人口規模が最重要要因だが地域特性も無視できない。地域ごとの最適な出店戦略が求められる。",

    "【データの制約】2005年のデータであり現在とは状況が異なる可能性。都道府県単位の集計データのため都市部と地方部の差が平均化されている。【因果関係の限界】本分析は相関関係を示すが因果関係までは特定できない。「東日本だから未婚率が高い」のか「未婚率が高い人が東日本に集まる」のかは判別不可。時系列データがあれば因果関係の推定も可能。",

    "【時系列分析】同じ都道府県の時系列データを分析することで変化のトレンドを把握できる。「格差は拡大しているのか縮小しているのか」を検証可能。【詳細な地域分析】都道府県よりも細かい市町村レベルでの分析により、都市部と地方部の差を明確化。【回帰分析】複数の説明変数を同時に投入し、各要因の相対的な影響力を定量化。「人口が1万人増えると小売店舗数は何件増えるか」などの予測モデル構築。",

    "本分析により、日本の都道府県データにおける地域差と人口規模の影響を統計的に明らかにすることができた。段階的な分析手法(t検定→1要因分散分析→2要因分散分析)により、データの背後にある構造を多角的に理解できた。東日本の都市的特性、人口規模の経済的影響、そして両者の交互作用という複雑な関係性が明らかになり、地域政策や市場戦略を考える上で有用な知見が得られた。"
  ),
  stringsAsFactors = FALSE
)

addWorksheet(wb, "総合まとめ", gridLines = FALSE)
writeData(wb, "総合まとめ", summary, startRow = 1, startCol = 1)
setColWidths(wb, "総合まとめ", cols = 1, widths = 25)
setColWidths(wb, "総合まとめ", cols = 2, widths = 100)

# ワークブックを保存
saveWorkbook(wb, "kadai3_results.xlsx", overwrite = TRUE)

cat("\n=================================================\n")
cat("解説シートを追加しました！\n")
cat("=================================================\n")
cat("追加されたシート:\n")
cat("  - 課題1_解説\n")
cat("  - 課題2_解説\n")
cat("  - 課題3_解説\n")
cat("  - 総合まとめ\n")
cat("\nkadai3_results.xlsx を確認してください。\n")
